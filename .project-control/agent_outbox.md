# Agent Outbox

## ???????????? ??????
- ?????? ??????? ??? KPI ?? ???????.
- ??????? ??????? ?? ???????: ?????? + ????????? - ???????? - ??????.
- ???????? tooltip ? 4 ???????? ??????? ???????.
- ? ???????? ?? ???? ???????? `+` ????? ?????????????? ???????.
- ??????? ???????? ????????? ??????? ???.
- ????????? ??????? dev-??????? ??? ??????? ????? 3000 (`EADDRINUSE`).

## ?????????
- `src/routes.ts`:
  - ??? `/api/analytics` ?????????? ???????????? ?????? ???????:
    - `couponsIncome` + `dividendsIncome` - `commissionsTotal` - `taxesTotal`;
  - `profitRub/profitPct` ?????? ???????? ?? ???? ???????;
  - ???????? ?????? `profitBreakdown` (??????/?????????/????????/??????) ??? tooltip ?? UI.
- `src/ui/homePage.ts`:
  - ??????? `kpi-sub` ?????? ? ??????? KPI;
  - ???????? ??????? ??????? `kpi-profit-card` ? ???????? hover-tooltip ? 4 ???????? ????????;
  - tooltip ??????????? ?? `profitBreakdown` ? ????? ???????????/????????????????? ?? ????;
  - ? ????????? ?? ????? ????????????? ????? ?????? ????????? ? ????? `+`;
  - ???? ?????????? ???????? ???? ?? ???? ????? ?? 4 ??????? ?? ??????? ?????? (? ?????????? ????????? ?? ?????).
- `src/server.ts`:
  - ???????? fallback-??????: ???? `PORT` ????? (`EADDRINUSE`), ?????? ??????? ????????? ???? (`+1`) ?????? ?????????? ??????????.

## ????????
- `npm test` ? ???????.

## ?????????
??????????? ??????? ? ??????????? ?? ??????? ????????????? ????? ???????????, ????????? KPI/??????? ????????, ? dev-?????? ?????? ?? ?????? ??? ??????? ????? 3000.
### 2026-02-12 21:10 - Fix profit breakdown zeros on home
- Root cause: /api/analytics did not robustly detect operation type when `operation_type` was absent or numeric.
- Updated `src/routes.ts`:
  - use `operation_type ?? type` as source,
  - normalize matching by string/upper/numeric id,
  - added `taxTypeIds` fallback,
  - added text fallback checks for coupon/dividend/commission/tax,
  - kept analytics soft-fallback behavior.
- Updated `src/ui/homePage.ts`: cache key bumped to `home_portfolio_cache_v7` to invalidate stale cached breakdown.
- Validation: `npm test` passed (`check-project-control`, `check-encoding`, tests).
### 2026-02-12 21:35 - Fix overstated payout cards
- Tightened operation classification in `src/routes.ts`:
  - coupon/dividend/commission now use enum names/ids only,
  - tax uses enum ids + TAX-type name match only.
- Updated dividend forecast aggregation:
  - ignore cancelled dividend events (`dividend_type` contains `cancel`),
  - skip non-positive dividend amounts.
- This reduces false-positive matches that were inflating:
  - `receivedDividends12` card,
  - `incomeNext12` card.
- Validation: `npm test` passed (project-control, encoding, tests).
### 2026-02-12 22:00 - Profit scoped to current holdings since purchase
- Updated `src/routes.ts` profit aggregation logic.
- Added current portfolio instrument sets (`figi`, `instrument_uid`).
- Added first pass over operations to detect earliest buy timestamp per current instrument.
- Profit components now include only operations that:
  - belong to current portfolio instruments, and
  - are dated on/after first buy date for that instrument.
- Applied scope to coupon/dividend/commission/tax parts of profit formula.
- Kept `receivedDividendOps` collection for dividends chart separate from scoped profit accumulation.
- Validation: `npm test` passed.
### 2026-02-12 22:20 - Coupons from sold/redeemed assets in profit + Project Control language fix
- Updated `src/routes.ts`: `couponsIncome` now counts actually received coupon operations regardless of whether the asset is still in current portfolio.
- Kept portfolio-scope filter for other profit components unchanged.
- Restored Russian text in Project Control tasks that had switched to English/garbled text.
### 2026-02-12 22:45 - Home movers redesign (no tabs)
- Updated `src/ui/homePage.ts` movers section:
  - removed tab switcher and heading "�������� �� ����",
  - added two side-by-side blocks: "��� ����� �� ����" and "��� ������� �� ����".
- Updated JS rendering:
  - removed `activeTab`, `tabUp`, `tabDown`, and tab click handlers,
  - added `renderMoverList()` and independent rendering for up/down lists.
- Added responsive behavior: movers columns collapse to one column on narrow screens.
- Validation: `npm test` passed.

### 2026-02-12 21:37 - Rework home profit to lifetime PnL
- Updated `src/routes.ts` (`/api/analytics`) profit formula to lifetime model:
  - `profit = current_value + sells + coupons + dividends - buys - commissions - payout_taxes`.
- Added new profit breakdown fields from API:
  - `currentValueRub`, `buysRub`, `sellsRub` (kept existing coupon/dividend/commission/tax fields).
- Removed current-holdings-only filter from profit accumulation so sold assets and historical operations are included.
- Limited tax deduction in this KPI to dividend/coupon tax operations.
- Updated `src/ui/homePage.ts`:
  - profit tooltip now shows current value, sells, buys, coupons, dividends, commissions, payout taxes,
  - client state/cache updated for new breakdown fields,
  - cache key bumped to `home_portfolio_cache_v8`.
- Validation: `npm test` passed (`check-project-control`, `check-encoding`, tests).
